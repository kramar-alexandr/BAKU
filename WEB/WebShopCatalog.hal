external procedure ExtractObj(string,var Integer,var string);function boolean CheckRequestForSend(area ames,var string opencurlybr,var string closecurlybr,var string opensqrbr,var string closesqrbr,var string paws,var string colon,var string space,var string nextline,var string comma)begin	  LongInt lines;  boolean res;  	lines = GetAreaLength(ames);	if (lines==0 or FindStringInArea("FAIL",ames)>-1) then begin		res = true;				opencurlybr = "{";	  	closecurlybr = "}";	  	opensqrbr = "[";	  	closesqrbr = "]";	  	paws = "\"";	  	colon = ":";	  	space = " ";	  	nextline = chr(13) & chr(10);	  	comma = ",";	  		end else begin		res = false;	end;  CheckRequestForSend = res; return;end;globalupdating function boolean HandleWebSendItems(area ames)begin  record INVc INr;  row INVc INrw;  record DIVc DIr;  record PLVc PLr;  record CompaniesBlock Compb;  row CompaniesBlock Comprw;  string 2 opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,comma;  string 5 nextline;  boolean TrHs,testf;  integer newrec;  boolean sendf;  integer pos,i,j,rwcnt,rwcnt1,oldcompany,loopcnt,price;  string 20 classfound,brand,type,suff;  string 255 azedescr,rusdescr,engdescr,azename,rusname,engname;  string 100 filepathP,filepathC;  area imagearea;  	  	sendf = CheckRequestForSend(ames,opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,nextline,comma);  		oldcompany = CurrentCompany;      BlockLoad(Compb);    rwcnt1 = MatRowCnt(Compb);      for (j=0;j<rwcnt1;j=j+1) begin      	MatRowGet(Compb,j,Comprw);      	if (/*StringToInt(Comprw.CompCode)==3 and*/ SetCompanyCode(Comprw.CompCode,false) and Comprw.ActiveStatus==0) then begin			filepathP = "webcust/" & Comprw.ShortName & "/";			suff = "_cmpnr_" & Comprw.CompCode;						loopcnt = 0;			INr.SyncFlag = 1;			TrHs = true;			while (LoopKey("SyncFlag",INr,1,TrHs)) begin				testf = true;				if (INr.SyncFlag!=1) then begin TrHs = false; testf = false; end;				//if (loopcnt>10) then begin  TrHs = false; testf = false; end;				if (sendf) then begin					if (testf) then begin						brand = "";						type = "";						pos = 0;						classfound = "";						ExtractObj(INr.DispGroups,pos,classfound);						while(nonblank(classfound)) begin							DIr.Code = classfound;							readfirstmain(DIr,1,true);							if(DIr.CType=="BRAND")then begin								brand = DIr.Code & suff;							end;							if(DIr.CType=="TYPE")then begin								type = DIr.Code & suff;							end;							ExtractObj(INr.DispGroups,pos,classfound);						end;						AddTextToArea(opencurlybr & nextline, ames);						AddTextToArea(paws & "typeid" & paws & colon & space & paws & type & paws & comma & nextline, ames);						AddTextToArea(paws & "brandid" & paws & colon & space & paws & brand & paws & comma & nextline, ames);						AddTextToArea(paws & "code" & paws & colon & space & paws & INr.Code & suff & paws & comma & nextline, ames);						AddTextToArea(paws & "collection" & paws & colon & space & paws & "" & paws & comma & nextline, ames);						azename = "";						azedescr = "";						rusname = "";						rusdescr = "";						engname = "";						engdescr = "";						rwcnt = MatRowCnt(INr);						for (i=0;i<rwcnt;i=i+1) begin							MatRowGet(INr,i,INrw);							if (UpperCase(INrw.LangCode)=="AZ" or UpperCase(INrw.LangCode)=="AZE") then begin								azename = INrw.Text;								azedescr = INrw.Description;							end;							if (UpperCase(INrw.LangCode)=="RU" or UpperCase(INrw.LangCode)=="RUS") then begin								rusname = INrw.Text;								rusdescr = INrw.Description;							end;							if (UpperCase(INrw.LangCode)=="EN" or UpperCase(INrw.LangCode)=="ENG") then begin								engname = INrw.Text;								engdescr = INrw.Description;							end;						end;						if (Blank(engname)) then begin							engname = INr.Name;						end;												AddTextToArea(paws & "title" & paws & colon & space & opensqrbr & opencurlybr, ames);						AddTextToArea(paws & "az" & paws & colon & space & paws & azename & paws & comma & space, ames);						AddTextToArea(paws & "ru" & paws & colon & space & paws & rusname & paws & comma & space, ames);						AddTextToArea(paws & "en" & paws & colon & space & paws & engname & paws, ames);						AddTextToArea(closecurlybr & closesqrbr & comma & nextline, ames);												PLr.PLCode = "RRP";		        		PLr.ArtCode = INr.Code;		        		ReadFirstMain(PLr,2,true);		        		price = PLr.ExVatPrice;						AddTextToArea(paws & "price" & paws & colon & space & price & comma & nextline, ames);												AddTextToArea(paws & "description" & paws & colon & space & opensqrbr & opencurlybr, ames);						AddTextToArea(paws & "az" & paws & colon & space & paws & azedescr & paws & comma & space, ames);						AddTextToArea(paws & "ru" & paws & colon & space & paws & rusdescr & paws & comma & space, ames);						AddTextToArea(paws & "en" & paws & colon & space & paws & engdescr & paws, ames);						AddTextToArea(closecurlybr & closesqrbr & comma & nextline, ames);												AddTextToArea(paws & "technical" & paws & colon & space & opensqrbr & opencurlybr, ames); // data for "technical" not selected						AddTextToArea(paws & "az" & paws & colon & space & paws & "" & paws & comma & space, ames);						AddTextToArea(paws & "ru" & paws & colon & space & paws & "" & paws & comma & space, ames);						AddTextToArea(paws & "en" & paws & colon & space & paws & "" & paws, ames);						AddTextToArea(closecurlybr & closesqrbr & comma & nextline, ames);												filepathC = "";						if (FILEEXISTS(filepathP & INr.Code & ".jpeg")) then begin							filepathC = filepathP & INr.Code & ".jpeg";						end else begin							if (FILEEXISTS(filepathP & INr.Code & ".png")) then begin								filepathC = filepathP & INr.Code & ".png";							end else begin								if (FILEEXISTS(filepathP & INr.Code & ".jpg")) then begin									filepathC = filepathP & INr.Code & ".jpg";								end;							end;						end;						AddTextToArea(paws & "image" & paws & colon & space & paws, ames);						if (NonBlank(filepathC)) then begin							SetAreaZeroSize(imagearea);							AddFileToArea(filepathC,imagearea,true);							InsertAreaBeforeArea(ames,imagearea);							ames = imagearea;						end;						AddTextToArea(paws & comma & nextline, ames);								if (INr.SavedCount<=1) then begin							newrec = 1;						end else begin							newrec = 0;						end;						AddTextToArea(paws & "newrecord" & paws & colon & space & newrec & nextline, ames);						AddTextToArea(closecurlybr & nextline, ames);						INr.TempFlag = 1;						RECORDSTORE(INr,true);					end;				end else begin					if (INr.TempFlag!=1) then begin testf = false; end;					if (testf) then begin						INr.TempFlag = 0;						INr.SyncFlag = 0;						RECORDSTORE(INr,true);					end;				end;				loopcnt = loopcnt + 1;				end; RESETLOOP(INr);			LogText(0,"Goods are synchronized for company " & Comprw.CompName);		end;	end;		ResetCompany(oldcompany);		if (sendf) then begin		//WRITEAREATOFILE(ames,"Sent.txt",0);		//WebOutString(GetStringFromArea(ames,0,GetAreaLength(ames)));		WebOutArea(ames);	end;		HandleWebSendItems = sendf;    return;end;global webpublic Procedure WebSendItems() //Edit***************************Sasha2,15:18 04.07.2014begin  area ames;      logtext(0,"WebSendItems");      	webgetpostdata(ames);  	//WRITEAREATOFILE(ames,"Received.txt",0);  	  	if (qupdating.HandleWebSendItems(ames)) then begin  		logText(0,"Items are sent");  	end;return;end;global webpublic updating Procedure WebSendBrands() //Edit***************************Sasha2,15:18 04.07.2014begin  record DIVc DIr;  record CompaniesBlock Compb;  row CompaniesBlock Comprw;  string 2 opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,comma;  string 5 nextline;  boolean TrHs,testf;  area ames;  integer newrec,oldcompany,i,rwcnt;  boolean sendf;  string 20 suff;    	logtext(0,"WebSendBrands");  	  	webgetpostdata(ames);  	//WRITEAREATOFILE(ames,"Received.txt",0);  	  	sendf = CheckRequestForSend(ames,opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,nextline,comma);	oldcompany = CurrentCompany;      BlockLoad(Compb);    rwcnt = MatRowCnt(Compb);      for (i=0;i<rwcnt;i=i+1) begin      	MatRowGet(Compb,i,Comprw);      	if (/*StringToInt(Comprw.CompCode)==3 and*/ SetCompanyCode(Comprw.CompCode,false) and Comprw.ActiveStatus==0) then begin      		      		suff = "_cmpnr_" & Comprw.CompCode;				DIr.SyncFlag = 1;			//DIr.CType = "BRAND";			TrHs = true;			while (LoopKey("SyncFlag",DIr,1,TrHs)) begin				testf = true;				if (DIr.SyncFlag!=1) then begin TrHs = false; testf = false; end;				if (DIr.CType!="BRAND") then begin testf = false; end;				if (sendf) then begin					if (testf) then begin						AddTextToArea(opencurlybr & nextline, ames);						AddTextToArea(paws & "uid" & paws & colon & space & paws & DIr.Code & suff & paws & comma & nextline, ames);						AddTextToArea(paws & "title" & paws & colon & space & opensqrbr & opencurlybr, ames);						AddTextToArea(paws & "az" & paws & colon & space & paws & DIr.Name_AZ & paws & comma & space, ames);						AddTextToArea(paws & "ru" & paws & colon & space & paws & DIr.Name_RU & paws & comma & space, ames);						AddTextToArea(paws & "en" & paws & colon & space & paws & DIr.Name & paws, ames);						AddTextToArea(closecurlybr & closesqrbr & comma & nextline, ames);						if (DIr.SavedCount<=1) then begin							newrec = 1;						end else begin							newrec = 0;						end;						AddTextToArea(paws & "newrecord" & paws & colon & space & newrec & nextline, ames);						AddTextToArea(closecurlybr & nextline, ames);						DIr.TempFlag = 1;						RECORDSTORE(DIr,true);					end;				end else begin					if (DIr.TempFlag!=1) then begin testf = false; end;					if (testf) then begin						DIr.TempFlag = 0;						DIr.SyncFlag = 0;						RECORDSTORE(DIr,true);					end;				end;				end; RESETLOOP(DIr);			LogText(0,"Brands are synchronized for company " & Comprw.CompName);		end;	end;		ResetCompany(oldcompany);		if (sendf) then begin		//WRITEAREATOFILE(ames,"Sent.txt",0);		//WebOutString(GetStringFromArea(ames,0,GetAreaLength(ames)));		WebOutArea(ames);		logText(0,"Brands are sent");	end;return;end;global webpublic updating Procedure WebSendTypes() //Edit***************************Sasha2,15:18 04.07.2014begin  record DIVc DIr;  record CompaniesBlock Compb;  row CompaniesBlock Comprw;  string 2 opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,comma;  string 5 nextline;  boolean TrHs,testf;  area ames;  integer newrec,oldcompany,i,rwcnt;  boolean sendf;  string 20 suff;    	logtext(0,"WebSendTypes");  	  	webgetpostdata(ames);  	  	sendf = CheckRequestForSend(ames,opencurlybr,closecurlybr,opensqrbr,closesqrbr,paws,colon,space,nextline,comma);	oldcompany = CurrentCompany;      BlockLoad(Compb);    rwcnt = MatRowCnt(Compb);      for (i=0;i<rwcnt;i=i+1) begin      	MatRowGet(Compb,i,Comprw);      	if (/*StringToInt(Comprw.CompCode)==3 and*/ SetCompanyCode(Comprw.CompCode,false) and Comprw.ActiveStatus==0) then begin      		      	suff = "_cmpnr_" & Comprw.CompCode;	      	
	      	DIr.SyncFlag = 1;			//DIr.CType = "TYPE";			TrHs = true;			while (LoopKey("SyncFlag",DIr,1,TrHs)) begin				if (DIr.SyncFlag!=1) then begin TrHs = false; testf = false; end;				if (DIr.CType!="TYPE") then begin testf = false; end;				testf = true;				if (sendf) then begin					if (testf) then begin						AddTextToArea(opencurlybr & nextline, ames);						AddTextToArea(paws & "uid" & paws & colon & space & paws & DIr.Code & suff & paws & comma & nextline, ames);						AddTextToArea(paws & "title" & paws & colon & space & opensqrbr & opencurlybr, ames);						AddTextToArea(paws & "az" & paws & colon & space & paws & DIr.Name_AZ & paws & comma & space, ames);						AddTextToArea(paws & "ru" & paws & colon & space & paws & DIr.Name_RU & paws & comma & space, ames);						AddTextToArea(paws & "en" & paws & colon & space & paws & DIr.Name & paws, ames);						AddTextToArea(closecurlybr & closesqrbr & comma & nextline, ames);						if (DIr.SavedCount<=1) then begin							newrec = 1;						end else begin							newrec = 0;						end;						AddTextToArea(paws & "newrecord" & paws & colon & space & newrec & nextline, ames);						AddTextToArea(closecurlybr & nextline, ames);						DIr.TempFlag = 1;						RECORDSTORE(DIr,true);					end;				end else begin					if (DIr.TempFlag!=1) then begin testf = false; end;					if (testf) then begin						DIr.TempFlag = 0;						DIr.SyncFlag = 0;						RECORDSTORE(DIr,true);					end;				end;				end; RESETLOOP(DIr);			LogText(0,"Types are synchronized for company " & Comprw.CompName);		end;	end;		ResetCompany(oldcompany);	if (sendf) then begin		//WebOutString(GetStringFromArea(ames,0,GetAreaLength(ames)));		WebOutArea(ames);		logText(0,"Types are sent");	end;return;end;